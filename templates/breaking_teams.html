{% extends "base.html" %}
{% load static %}
{% load debate_tags %}

{% block head-title %}
  {{ category.name }} Break
  <small>({{ public_breaking_teams|yesno:",not "}}publicly visible)</small>
{% endblock %}
{% block page-title %}{{ category.name }} Break{% endblock %}
{% block body-class %}breaking-teams-{{ category.slug }}{% endblock %}

{% block header %}
  {% if generated %}
    <div class="alert alert-warning">
      Please double-check this before announcing the break or releasing it to the
      public. The code that generates the break has not been robustly tested for
      corner cases. If there are errors, please take a snapshot of the database
      and a screenshot and send it to the developers. You can edit the breaking
      teams list directly in the database through the Django Admin.
    </div>
  {% else %}
    {% if public_breaking_teams %}
      <div class="alert alert-danger">
        The <strong>public breaking teams</strong> configuration setting is
        enabled. As soon as you click the button, the breaking teams list will
        be visible on the public site, before you have a chance to
        double-check it! It is strongly recommended that you disable this
        setting on the <a href="{% tournament_url tournament_config %}">
        tournament configuration page</a> before generating the team
        breaks.
      </div>
    {% else %}
      <p>
        The break hasn't yet been generated. Would you like to generate
        the break for all categories?
      </p>
      <p>
        (It's safe to generate the break before all preliminary rounds are
        complete, if you're curious. You can regenerate it later.)
      </p>
    {% endif %}

  {% endif %}

  <div class="forms-block-inline">
    <form action="{% tournament_url generate_breaking_teams category.slug %}" method="POST">
      <button class="btn btn-{{ public_breaking_teams|yesno:"danger,success" }} form-control" id="generateBreakingTeams" type="submit">
        {% if generated %}
          Reset and regenerate the break for all categories
        {% else %}
          Generate the break for all categories
        {% endif %}
      </button>
    </form>
    {% if generated %}
    <form action="{% tournament_url update_all_breaking_teams category.slug %}" method="POST">
      <button class="btn btn-{{ public_breaking_teams|yesno:"danger,success" }} form-control" id="generateBreakingTeams" type="submit">
        Update the break for all categories
      </button>
    </form>
    <form action="{% tournament_url update_breaking_teams category.slug %}" method="POST">
      <button class="btn btn-{{ public_breaking_teams|yesno:"danger,success" }} form-control" id="generateBreakingTeams" type="submit">
        Update the break for this category ({{ category.name }})
      </button>
    </form>
    {% endif %}
  </div>
{% endblock %}

{% block content %}
  {% if generated %}
    <table id="dataTable" class="table table-hover table-striped" cellspacing="0" cellpadding="0">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Break</th>
          {% if show_emoji > 0 %}
            <th class="team-emoji"></th>
          {% endif %}
          <th>Team</th>
          {% if show_institutions > 0 %}
            <th>Inst<span class="hidden-xs">itution</span></th>
          {% endif %}
          <th>Wins</th>
          <th>Total speaker score</th>
        </tr>
      </thead>
      <tbody>
      {% for team in teams %}
      <tr>
        <td>{{ team.rank }}</td>
        <td>{{ team.break_rank|default_if_none:"&ndash;" }}</td>
        {% if show_emoji > 0 %}
          <td class="team-emoji">{% team_emoji team %}</td>
        {% endif %}
        <td>
          <span {% if show_speakers_in_draw %}class="team-speakers-hover" id="team_speakers_{{ team.id }}"{% endif %}>
            {{ team.long_name }}
            {{ team.categories_for_display }}
          </span>
        </td>
        {% if show_institutions > 0 %}
          <td><span class="hidden-xs">{{ team.institution }}</span><span class="visible-xs">{{ team.institution.code }}</span></td>
        {% endif %}
        <td>
          {{ team.points }}
        </td>
        <td>
          {{ team.speaker_score|stringformat:".2f" }}
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endblock content %}

{% block extra-js %}
  {{ block.super }}
  <script type="text/javascript" charset="utf-8">
    $(document).ready( function() {
      var dTable = $("#dataTable").DataTable({
        "aaSorting": [[ 0, "asc" ]],
      });
      new $.fn.dataTable.FixedHeader( dTable, {alwaysCloneTop: true});
      $('#table-search').keyup(function(){
        dTable.search($(this).val()).draw();
      })
    });
  </script>
{% endblock extra-js %}