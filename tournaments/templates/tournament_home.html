{% extends "base.html" %}
{% load static %}
{% load debate_tags %}
{% load compress %}

{% block page-title %}Dashboard{% endblock %}
{% block head-title %}Tournament Overview{% endblock %}
{% block body-id %}tournamentOverview{% endblock %}

{% block sub-title %}
  {{ round.name }} is {{ round.get_draw_status_display.lower }}
  (this page will refresh its data automatically)
{% endblock %}

{% block content %}

  {% if blank %}
    <div class="alert alert-info">
      <p>
        <strong>Welcome to your new tournament!</strong> The next step is to
        import your initial tournament data: the institutions, teams, adjudicators
        and venues that are in your tournament. There are a number of ways to do
        this. For small-to-medium tournaments, you can use the visual <a href="
        {% tournament_url data_index %}"><strong>data importer</strong></a>. (This is also the
        <em>Setup > Import Data</em> link on the left.)
      </p>
      <p>For more information, please consult our <a href="https://tabbycat.readthedocs.io/en/{{ readthedocs_version }}/use/importing-data.html">documentation on importing initial data</a>.</p>
    </div>
  {% endif %}

  <div class="row">
    <div class="col-sm-12">
      <h4 class="text-center">
        Number of Ballots In
      </h4>
      <div class="panel panel-default">
        <div class="panel-body">
          <ballots-graph poll-url="{% tournament_url ballots_status %}"></ballots-graph>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
        <h4 class="text-center">Latest Actions</h4>
        <ul class="list-group">
          <updates-list v-for="action in latestActions"
          :timestamp="action.timestamp" :user="action.user" :type="action.type"
          :param="action.param"></updates-list>
          <li class="list-group-item" v-if="latestActions.length === 0">No Actions In</li>
          <li class="list-group-item" v-if="latestActions === 'loading'">Loading...</li>
        </ul>
    </div>
    <div class="col-md-6">
        <h4 class="text-center">Latest Results</h4>
        <ul class="list-group">
          <updates-list  v-for="result in latestResults"
          :timestamp="result.timestamp" :user="result.user" :type="result.type"
          :param="result.param"></updates-list>
          <li class="list-group-item" v-if="latestResults.length === 0">No Results In</li>
          <li class="list-group-item" v-if="latestResults === 'loading'">Loading...</li>
        </ul>
    </div>
  </div>

{% endblock content %}

{% block extra-js %}

<script src="{% static 'js/vendor/d3.min.js' %}"></script>
{% include "vue/import-vue.html" %}
{% include "vue/updates-list.vue" %}
{% include "vue/ballots-graph.vue" %}

<script>

  var latests = new Vue({
    el: '#tournamentOverview',
    data: {
      latestActions: 'loading',
      latestResults: 'loading',
      pollFrequency: 30000, // 30 seconds
    },
    created: function () {
      this.updateActions();
      this.updateResults();
    },
    methods: {
      updateActions: function() {
        this.fetchData('{% tournament_url latest_actions %}', 'actions')
      },
      updateResults: function() {
        this.fetchData('{% tournament_url latest_results %}', 'results')
      },
      fetchData: function (apiURL, resource) {
        var xhr = new XMLHttpRequest()
        var self = this
        xhr.open('GET', apiURL)
        xhr.onload = function () {
          if (resource === 'actions') {
            self.latestActions = JSON.parse(xhr.responseText);
            setTimeout(self.updateActions, self.pollFrequency);
          } else {
            self.latestResults = JSON.parse(xhr.responseText);
            setTimeout(self.updateResults, self.pollFrequency);
          }
        }
        xhr.send()
      }
    }
  })

</script>
{% endblock %}
