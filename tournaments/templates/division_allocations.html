{% extends "base.html" %}
{% load debate_tags %}
{% load static %}

{% block head-title %}Allocate Divisions{% endblock %}
{% block page-title %}Allocate Divisions{% endblock %}
{% block body-class %}Allocate Divisions{% endblock %}

{% block page-subnav-sections %}
  <div id="statusBar" class="btn-group">
    <a class="btn btn-primary" href="#auto" id="auto_allocate">Auto Allocate</a>
    <a data-loading-text="Saving..." class="btn btn-success" href="" id="save">Save</a>
    <a data-loading-text="Allocating..." class="btn btn-danger" href="{% round_url draw current_round %}">Quit</a>
  </div>
  <div id="" class="btn-group">
    <a class="btn btn-default" data-toggle="modal" data-target="#view-venues">View Venue Stats</a>
    <a class="btn btn-default" data-toggle="modal" data-target="#view-divisions">View Division Stats</a>
  </div>
  <div class="btn btn-inactive">Preference Allocated:</div>
  <div id="" class="btn-group">
    <div class="btn btn-success" disabled="disabled">1/2</div>
    <div class="btn btn-primary" disabled="disabled">3/4</div>
    <div class="btn btn-warning" disabled="disabled">5+</div>
    <div class="btn btn-danger" disabled="disabled">None</div>
  </div>
  {% include "tables/table_search.html" %}
{% endblock %}

{% block content %}

  <!-- demo root element -->
  <div id="app">

    <div class="row">
      <div class="col-md-3" v-if="divisions.length > 0" class="row" v-for="division in divisions">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4>[[ division.name ]]</h4>
            <select name="select" class="form-control">
              <option v-for="vg in venue_groups" value="[[ vg.id ]]">[[ vg.short_name ]]</option>
            </select>
          </div>
          <div class="panel-body" v-drag-and-drop v-drop="handleDrop">
            <template v-for="team in division.teams">
              <team-draggable :id="team.id" :name="team.institution__code + ' ' + team.short_reference"></team-draggable>
            </template>
          </div>
        </div>
      </div>
      <div v-if="divisions.length == 0" class="col-md-12">
        <div class="alert alert-warning">
          No divisions have been added.
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12" v-if="divisions.length > 0" class="row" v-for="division in divisions">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4>Team</h4>
          </div>
          <div class="panel-body" v-drag-and-drop v-drop="handleDrop">
            <template v-for="team in teams">
              <team-draggable :id="team.id" :name="team.institution__code + ' ' + team.short_reference"></team-draggable>
            </template>
          </div>
        </div>
      </div>
    </div>

  </div>

{% endblock content %}

{% block extra-js %}
  <script type="text/javascript" language="javascript" src="{% static 'js/vendor/vue.js' %}"></script>
  <script type="text/javascript" language="javascript" src="{% static 'js/vendor/vue.drag-and-drop.js' %}"></script>
  {% include "vue/team-draggable.js" %}
  <script>

  Vue.config.delimiters = ["[[", "]]"];
  /* globals Vue */
  var App = new Vue({
    el: '#app',
    data: {
      loggedEvent: '',
      // images: [{"name":"Image 1","src":"http://placehold.it/100/000000/ffffff"},{"name":"Image 2","src":"http://placehold.it/100/C93742/ffffff"},{"name":"Image 3","src":"http://placehold.it/100/6894D1/ffffff"}],
      test: [
        {
          "name": "ZA",
          "teams": [
            { "name": "A" },
            { "name": "B" },
            { "name": "C" },
          ]
        },
        {
          "name": "ZB",
          "teams": [
            { "name": "1" },
            { "name": "2" },
            { "name": "3" },
          ]
        }
      ],
      teams: {{ teams | safe }},
      divisions: {{ divisions | safe }},
      venue_groups: {{ venue_groups | safe }}
    },
    ready: function() {
      Array.prototype.slice.call(document.querySelectorAll('.image'), 0).forEach(function(item){
        item.children[0].src = item.children[0].getAttribute('data-src');
      });
    },
    methods: {
      handleDragStart: function(elem) {
        // console.log('handleDragStart', elem);
        this.loggedEvent = 'handleDragStart';
      },
      handleDragOver: function(elem) {
        // console.log('handleDragOver', elem);
        this.loggedEvent = 'handleDragOver';
      },
      handleDragEnter: function(elem) {
        // console.log('handleDragEnter', elem);
        this.loggedEvent = 'handleDragEnter';
      },
      handleDragLeave: function(elem) {
        // console.log('handleDragLeave', elem);
        this.loggedEvent = 'handleDragLeave';
      },
      handleDragEnd: function(elem) {
        // console.log('handleDragEnd', elem);
        this.loggedEvent = 'handleDragEnd';
      },
      handleDivisionDropArea: function(draggedItem, droppedArea) {
        console.log('handleDivisionDropArea', draggedItem.getAttribute('data-index'), droppedArea.getAttribute('data-index'));
        this.divisions[0].push(draggedItem);
        this.divisions[1].$remove(draggedItem);
      }
    }
  });

  //
  // $('#save').click( function() {
  //   var teams = {};
  //   var btn = $(this)
  //   btn.button('loading')
  //   $("#dataTable .division").each( function() {
  //     var new_division_id = $("select", this).val()
  //     console.log(new_division_id)
  //     if (new_division_id != "") {
  //       teams[$(this).attr("id")] = new_division_id;
  //     }
  //   });
  //   $.ajax({
  //     type: "POST",
  //     url: "{% tournament_url save_divisions %}",
  //     data: teams,
  //     success: function(data, status) {
  //       $("#alerts-holder").html('<div class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert">&times;</button>Saved successfully!</div>');
  //       btn.button('reset')
  //     },
  //     error: function(xhr, error, ex) {
  //       console.log(xhr.responseText);
  //       alert(xhr.responseText); //throw actual error, just for debugging purpose
  //       $("#alerts-holder").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert">&times;</button>Save failed!</div>');
  //       btn.button('reset')
  //     }
  //   });
  //   return false;
  // });
  //
  // $('#auto_allocate').click(function() {
  //   var btn = $(this)
  //   btn.button('loading')
  //   $.ajax({
  //     type: "POST",
  //     url: "{% tournament_url create_division_allocation %}",
  //     success: function(data, status) {
  //       $("#alerts-holder").html('<div class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert">&times;</button>Allocated successfully, please refresh the page to see it!</div>');
  //       btn.button('reset')
  //     },
  //     error: function(xhr, error, ex) {
  //       $("#alerts-holder").html('<div class="alert alert-danger alert-dismissable" id=""><button type="button" class="close" data-dismiss="alert">&times;</button>Auto-allocation failed! '
  //         + xhr.responseText + ' (' + xhr.status + ')</div>');
  //       btn.button('reset')
  //     }
  //   });
  //
  // });

  </script>


{% endblock extra-js %}
