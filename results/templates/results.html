{% extends "draw_rbase.html" %}
{% load debate_tags %}

{% block page-title %}Results for {{ round.name }}{% endblock %}
{% block head-title %}<span class="emoji">ðŸ“©</span>Results{% endblock %}
{% block sub-title %}for {{ round.name }}{% endblock %}

{% block page-subnav-sections %}
  <a class="btn btn-default submit-disable" href="{% round_url ballot_checkin current_round %}">Ballot Checkin</a>
  {% include "tables/table_search.html" %}
{% endblock %}

{% block page-subnav-actions %}
  {% if round.seq < tournament.round_set.count and current_round == round %}
    <a class="btn btn-success submit-disable" href="{% round_url round_increment_check %}">
      Advance to Next Round <span class="glyphicon glyphicon-chevron-right"></span>
    </a>
  {% endif %}
{% endblock %}

{% block page-alerts %}
  {% if not has_motions %}
    <div class="alert alert-danger">
      Currently there are no motions entered for this round, so debate results
      cannot be entered. <a href="{% round_url motions current_round %}" class="alert-link">Add Motions.</a>
    </div>
  {% endif %}
{% endblock %}

{% block content %}

  <div class="row">
    <div class="col-sm-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          <div class="btn-group btn-group-justified" role="group">
            <span class="btn btn-default debate-status-in">
              <span class="glyphicon glyphicon-inbox"></span> {{ stats.ballot_in }} Checked In
            </span>
            <span class="btn btn-default debate-status-unknown">
              <span class="glyphicon glyphicon-remove"></span> {{ stats.none }} Unknown
            </span>
            <span class="btn btn-default debate-status-unconfirmed">
              <span class="glyphicon glyphicon-adjust"></span> {{ stats.draft }} Unconfirmed
            </span>
            <span class="btn btn-default debate-status-confirmed">
              <span class="glyphicon glyphicon-ok"></span> {{ stats.confirmed }} Confirmed
            </span>
            {% if pref.enable_postponements %}
              <span class="btn btn-default debate-status-postponed">
                <span class="glyphicon glyphicon-pause"></span> {{ stats.postponed }} Postponed
              </span>
              <span class="btn btn-default debate-status-bye">
                <span class="glyphicon glyphicon-fast-forward"></span> Bye
              </span>
            {% endif %}
          </div>
        </div>
        <div class="panel-body">

          <table id="dataTable" class="table table-hover">
            <thead>
              <tr>
                <th><span class="glyphicon glyphicon-th-list" data-toggle="tooltip" title="Ballot Status"></span></th>
                <th>Ballots</th>
                {% if pref.enable_postponements %}
                  <th><span class="glyphicon glyphicon-pause" data-toggle="tooltip" title="Postponements"></span></th>
                {% endif %}
                <th><span class="glyphicon glyphicon-sort" data-toggle="tooltip" title="Bracket"></span></th>
                <th><span class="glyphicon glyphicon-map-marker" data-toggle="tooltip"title="Venue"></span></th>
                <th>Aff<span class="hidden-xs">irmative</span></th>
                <th>Neg<span class="hidden-xs">ative</span></th>
                <th>Adj<span class="hidden-xs">udicator</span>s</th>
              </tr>
            </thead>

            <tbody>

            {% for debate in draw %}
              <tr class="debate-status-{% if debate.aff_team.type == 'B' or debate.neg_team.type == 'B' %}bye{% else %}{{debate.result_status}}{% endif %}">
                {% include 'tables/debate_icon.html' %}
                <td class="ballot_links">
                  <!-- TODO clean this CSS stuff up -->
                  {% for ballotset in debate.ballotsubmission_set_by_version %}
                    <a href="{% tournament_url edit_ballotset ballotset.id %}" title="Edit Ballot" class="
                      {% if ballotset.confirmed %}edit-ballot-link-confirmed{% endif %}
                      {% if ballotset.discarded %}edit-ballot-link-discarded{% endif %}
                    ">
                      {% if ballotset.confirmed %}Re-edit{% else %}{% block edit-link %}Edit{% endblock %}{% endif %}
                      {% if debate.ballotsubmission_set.count > 1%}
                        v{{ ballotset.version }}
                      {% endif %}
                      {% if ballotset.submitter_type == ballotset.SUBMITTER_TABROOM %}
                        <small>(entered by {{ ballotset.submitter }})</small></a>
                      {% elif ballotset.submitter_type == ballotset.SUBMITTER_PUBLIC %}
                        <small>(public submission, {{ ballotset.ip_address }})</small></a>
                      {% endif %}
                    <br>
                  {% endfor %}
                  {% if not debate.ballotsubmission_set_by_version_except_discarded.exists %}
                    {% if debate.aff_team.type != 'B' and debate.neg_team.type != 'B' %}
                      <a href="{% tournament_url new_ballotset debate.id %}" title="Create New Ballot">Enter</a>
                    {% endif %}
                  {% endif %}
                  <!-- end TODO -->
                </td>

                {% if pref.enable_postponements %}
                  <td>
                  {% if debate.result_status == debate.STATUS_POSTPONED %}
                    <a class="postpone-toggle" id="{{ debate.id }}" href="{% tournament_url toggle_postponed %}">Un-postpone</a>
                  {% elif debate.result_status != debate.STATUS_CONFIRMED and debate.aff_team.type != 'B' and debate.neg_team.type != 'B' %}
                    <a class="postpone-toggle" id="{{ debate.id }}" href="{% tournament_url toggle_postponed %}">Postpone</a>
                  {% endif %}
                  </td>
                {% endif %}

                <td>{{ debate.bracket }}</td>

                <td>{% if venue.group %}{{ venue.group.name }} {% endif %}{{ debate.venue.name }}</td>

                <td>
                   {% if debate.confirmed_ballot.forfeit %}
                    {% if debate.confirmed_ballot.forfeit == debate.aff_team %}
                      <span class="glyphicon glyphicon-eye-close text-danger"></span>
                    {% else %}
                      <span class="glyphicon glyphicon-share-alt text-success"></span>
                    {% endif %}
                  {% elif debate.confirmed_ballot.ballot_set.aff_win == 1 %}
                    <span class="glyphicon glyphicon-arrow-up text-success"></span>
                  {% elif debate.confirmed_ballot.ballot_set.neg_win == 1 %}
                    <span class="glyphicon glyphicon-arrow-down text-danger"></span>
                  {% endif %}
                    <span class="team-speakers-hover" id="team_speakers_{{ debate.aff_team.id }}">
                      {{ debate.aff_team.short_name }}
                    </span>
                </td>
                <td>
                  {% if debate.confirmed_ballot.forfeit %}
                    {% if debate.confirmed_ballot.forfeit == debate.neg_team %}
                      <span class="glyphicon glyphicon-eye-close text-danger"></span>
                    {% else %}
                      <span class="glyphicon glyphicon-share-alt text-success"></span>
                    {% endif %}
                  {% elif debate.confirmed_ballot.ballot_set.neg_win == 1 %}
                    <span class="glyphicon glyphicon-arrow-up text-success"></span>
                  {% elif debate.confirmed_ballot.ballot_set.aff_win == 1 %}
                    <span class="glyphicon glyphicon glyphicon-arrow-down text-danger"></span>
                  {% endif %}
                    <span class="team-speakers-hover" id="team_speakers_{{ debate.neg_team.id }}">
                      {{ debate.neg_team.short_name }}
                    </span>
                </td>
                <td>
                  {% if debate.confirmed_ballot %}
                    {% for type, adj, split in debate.confirmed_ballot.ballot_set.adjudicator_results %}
                      {% if split %}
                        <span class="text-danger">{{ adj.name }}{% if type == 'C' and debate.adjudicators.is_panel %} â’¸{% elif type == 'T' %} â“‰{% endif %}</span> <span class="glyphicon glyphicon-resize-full text-danger"></span>{% if not forloop.last %},{% endif %}
                      {% else %}
                        {{ adj.name }}{% if type == 'C' and debate.adjudicators.is_panel %} â’¸{% elif type == 'T' %} â“‰{% endif %}{% if not forloop.last %},{% endif %}
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    {% for type, adj in debate.adjudicators %}
                      {{ adj.name }}{% if type == 'C' and debate.adjudicators.is_panel %} â’¸{% elif type == 'T' %} â“‰{% endif %}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </table>
        </div><!-- end panel body -->
      </div><!-- end panel content -->
    </div><!-- end col -->
  </div><!-- end row -->
{% endblock content %}

{% block extra-js %}
  <script type="text/javascript">
    $(document).ready(function(){
      var dTable = $('#dataTable').DataTable({
        "aaSorting": [[ 0, "asc" ], [ 2, "desc" ], [ 3, "asc" ]],
      });
      new $.fn.dataTable.FixedHeader( dTable, {alwaysCloneTop: true});
      $('#table-search').keyup(function(){
        dTable.search($(this).val()).draw();
      })
      $("tr.debate-status-postponed td.ballot_links a").hide()

      $('.postpone-toggle').click( function() {
        $.ajax( {
          type: "POST",
          context: $(this),
          data: { 'debate' : $(this).attr('id') },
          url: $(this).attr('href'),
          success: function(data, status) {
            var row = $(this).parent().parent()
            if ($(this).text() === "Postpone") {
              $(this).text('Un-postpone');
              row.attr( "class", "debate-status-postponed" );
              row.find("td.icon_holder a span.glyphicon").attr( "class", "glyphicon glyphicon-pause");
              row.find("td.ballot_links a").hide()
            } else {
              $(this).text('Postpone');
              row.attr( "class", "debate-status-unknown" );
              row.find("td.icon_holder a span.glyphicon").attr( "class", "glyphicon glyphicon-remove");
              row.find("td.ballot_links a").show()
            }
          },
          error: function(xhr, error, ex) {
            $(this).text('Save Failed');
          }
        } );
        return false;
      });


    });
  </script>
{% endblock %}
