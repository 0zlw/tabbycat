{% extends "base.html" %}

{% block extra-head %}
<script type="text/javascript" language="javascript" src="/static/js/jquery-ui.js"></script>
<script type="text/javascript" charset="utf-8">
    $(document).ready( function() {
        var debates = {};
        // populate data
        $("#dataTable .venue-holder").each( function() {
            debates[$(this).attr("id")] = $("div.venue", this).attr("id");
        } );

        function venueMoved(venue, oldDebate, newDebate) {
            var oldId = oldDebate.attr("id");
            if (oldId != undefined && oldId != "scratch") {
                debates[oldId] = 'none';
            }
            var newId = newDebate.attr("id");
            if (newId != undefined && newId != "scratch") {
                debates[newId] = venue.attr("id");
            }
        }

        function addPlaceholder(toHolder) {
            toHolder.append('<div class="vo placeholder">&nbsp;</div>');
        }

        // init empties
        $("#dataTable div.empty").each( function() {
            var holder = $(this).parent("venue-holder");
            $(this).remove();
            addPlaceholder(holder);
        } );
            

        $(".venue").draggable( {
            handle: 'div',
            cursor: 'move',
            stack: {
                group: '.venue',
                min: 1
            },
            revert: 'invalid'
        });
        $(".venue").addClass("vo");
        $("#dataTable tbody tr td:last-child").droppable( {
            hoverClass: 'hover',
            drop: function(event, ui) {
                var venue = ui.draggable;
                var oldHolder = venue.parent("td");
                var replacing = $(".vo", this);
                var newHomeOff = replacing.offset();
                var curOff = venue.offset();

                if (replacing.attr("id") != venue.attr("id")) {
                    if (replacing.attr("id") != undefined) {
                        //replacing another venue
                        venueMoved(replacing, $(this), $("#scratch"));
                        $("#scratch").append(replacing);
                    } else {
                        //replacing a placeholder
                        replacing.remove();
                    }
                    $(this).append(venue);
                    addPlaceholder(oldHolder);
                }

                venueMoved(venue, oldHolder, $(this));

                venue.css('top', curOff.top - newHomeOff.top);
                venue.css('left', curOff.left - newHomeOff.left);
                venue.animate({'top': '0', 'left': '0'}, 300);
            }

        });

        $("#scratch").droppable( {
            hoverClass: 'hover',
            drop: function(event, ui) {
                var venue = ui.draggable;
                var oldHolder = venue.parent("td");
                $(this).append(venue);
                addPlaceholder(oldHolder);

                venueMoved(venue, oldHolder, $(this));
                venue.animate({'top': '0', 'left': '0'}, 300);


            }


        } );
        $("#scratch").append('<div class="placeholder"></div>');

        /* sorting function for venues */
        $.fn.dataTableExt.afnSortData['venue'] = function ( oSettings, iColumn) {
            var aData = [];
            $('.vo', oSettings.oApi._fnGetTrNodes(oSettings)).each( function () {
                var name = $('span', this).html();
                if (name == null) name = '';
                aData.push(name);
            });
            return aData;
        };

        /* filter function for venues */
        $.fn.dataTableExt.ofnSearch['venue'] = function ( sData ) {
            var jo = $(sData);
            var f = $('span', jo).html();

            return f;
        };

        $('#save').click( function() {
            $.ajax( {
                type: "POST",
                url: "{% url save_venues round.id %}",
                data: debates,
                success: function(data, status) {
                    alert("win");
                },
                error: function(xhr, error, ex) {
                    alert("fail");
                }
            } );

            return false;

        } );

        $("#dataTable").dataTable( {
            "aoColumns": [
                null,
                null,
                null,
                { "sSortDataType": "venue" }
            ],
            "bPaginate": false
        } );
    });
</script>
<style type="text/css">
    .venue { background-color: #ccc; }
    .venue span { margin-left: 10px; }
    #dataTable td.hover { background-color: #ff8; }
    #scratch {
        position: fixed;
        top: 0;
        right: 0;
        background-color: #cff;
        width: 20%;
        height: 800px;
    }
    #scratch.hover { background-color: #ff8; }
    #main {
        width: 79%;
    }

</style>
{% endblock extra-head %}

{% block extra-style %}
    @import "/static/css/demo_table.css";
{% endblock %}


{% block body %}

<div id="statusBar">
    Edit venues for Round {{ round }} |
    <a href="" id="save">Save</a>
    Discard Undo Redo 
    <a href="{% url draw round.id %}">Quit</a>
</div>

<div id="scratch">
    Unused Venues
    {% for venue in round.unused_venues %}
    <div id="venue_{{ venue.id }}" class="venue">
        <span>{{ venue }}</span>
    </div>
    {% endfor %}
</div>

<div id="main">
    <table id="dataTable" class="display" cellpadding="0" cellspacing="0">
        <thead>
            <tr><th>Bracket</th><th>Affirmative</th><th>Negative</th><th>Venue</th></tr>
        </thead>
        <tbody>
        {% for debate in draw %}
        <tr class="{{ debate.draw_conflicts|yesno:'conflict,' }}">
            <td>{{ debate.bracket }}</td>
            <td>{{ debate.aff_team }}</td>
            <td>{{ debate.neg_team }}</td>
            <td id="debate_{{ debate.id }}" class="venue-holder">
                <div id="venue_{{ debate.venue.id }}" class="
                    {% if debate.venue %}venue{% else %}empty{% endif %}"><span>{{ debate.venue }}</span></div></td>
        </tr>
        {% endfor %}
    </table>
</div>

{% endblock body %}


