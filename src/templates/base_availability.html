{% extends "draw_rbase.html" %}

{% block extra-head %}
    <script type="text/javascript" charset="utf-8">
        var dTable;
        var venueState = [];
        var newState = [];
        var unsavedChanges = 0;
        var checkboxes = function () { return $("#dataTable tbody tr :checkbox") };
        var updateCheckbox = function(cb) {
            var jp = $(cb).parents("tr");
            if (cb.checked) {
                jp.addClass("active");
                jp.removeClass("inactive");
                if (venueState[cb.value]) {
                    jp.removeClass("pendingChange");
                } else {
                    jp.addClass("pendingChange");
                }
            } else {
                jp.addClass("inactive");
                jp.removeClass("active");
                if (venueState[cb.value]) {
                    jp.addClass("pendingChange");
                } else {
                    jp.removeClass("pendingChange");
                }
            }
        };

        var changeHappened = function (e) {
            unsavedChanges++;
            if (!unsavedChanges) {
//                $(".status").append("<span>Unsaved changes</span");
//                unsavedChanges = true;
            }

        }

        $(document).ready( function() {
            checkboxes().each( function(){
                var cb = $(this)[0];
                venueState[cb.value] = cb.checked;
                updateCheckbox(this);
            });
            checkboxes().click( function(){
                updateCheckbox(this);
                changeHappened(this);
            });

            $("#dataTable tbody tr").click( function(event) {
                if (event.target.type !== "checkbox") {
                    var jc = $(":checkbox", this);
                    jc[0].checked = !jc[0].checked;
                    jc.triggerHandler("click");
                }
            });

            var update_url = "{% block update-url %}{% endblock %}";
            $("#dataTable tbody tr").addClass("clickable");

            $('#btn_copy').click(function() {
                var form = document.createElement("form");
                $(form).attr('method', 'POST').attr('action', update_url).appendTo($('body'));
                var input = document.createElement("input");
                $(input).attr('type', 'hidden').attr('name', 'copy').attr('value', '1').appendTo(form);
                form.submit();
                return false;

            });

            $("#form").submit( function() {
                checkboxes().each( function(){
                    var cb = $(this)[0];
                    newState[cb.value] = cb.checked;
                });

                var sData = $("input", dTable.fnGetNodes()).serialize();
                $.ajax({
                    type: "POST",
                    url: update_url,
                    data: sData,
                    success: function(data, txtStatus) {
                        venueState = newState;
                        checkboxes().each( function() {
                            updateCheckbox(this);
                        });
                        {% block post-success %}{% endblock %}

                    },
                    error: function(req, txtStatus, err) {
                    },
                });
                return false;
            } );

            dTable = $('#dataTable').dataTable({
                'bPaginate': false,
                "aoColumns": [
                      { "sType": "string" },
                      { "sType": "string" },
                        null
                    ],
                "aaSorting": [[ 0, "asc" ]]
            });

            $('#select_all').click(function() {
                checkboxes().each(function(){
                    if (!this.checked) {
                        $(this).click();
                        updateCheckbox(this);
                    }
                });
                return false;
            });


        } );
    </script>
{% endblock %}

{% block header %}
    <div class="status btn-group btn-group-lg">
        {% block copy_btn %}
        <button id="btn_copy" class="btn btn-default" type="button">Copy from previous</button>
        {% endblock %}
        <button type="submit" class="btn btn-default" >Save changes</button>
        <button id="select_all" class="btn btn-default" href="#all">Select All</a>
    </div>
{% endblock %}

{% block content %}
<form id="form">
    <table id="dataTable" class="table table-hover table-bordered table-striped" cellpadding="0", cellspacing="0">
        {% block table-contents %}
        {% endblock table-contents %}
    </table>
    <div class="status"></div>
</form>
{% endblock content %}


