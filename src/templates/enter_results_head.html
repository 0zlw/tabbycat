<style>
    #resultsForm input[type='text'] {
        width: 4em;
    }
    select.sp_error {
        border: 2px solid red;
    }
    select {
        border: 1px solid black;
    }
</style>

<script type="text/javascript">
    $(document).ready(function() {
        $("#resultsForm").validate({
        });

        function refresh_totals(table) {
            $table = $(table);
            $aff_total = $('.aff_total', $table);
            $neg_total = $('.neg_total', $table);

            var aff = sum($('.aff.score input', $table));
            var neg = sum($('.neg.score input', $table));
            $aff_total.val(aff);
            $neg_total.val(neg);

            if (aff > neg) {
                $aff_total.addClass('win').removeClass('lose');
                $neg_total.addClass('lose').removeClass('win');
            } else if (neg > aff) {
                $aff_total.addClass('lose').removeClass('win');
                $neg_total.addClass('win').removeClass('lose');
            } else {
                $aff_total.addClass('lose').removeClass('win');
                $neg_total.addClass('lose').removeClass('win');
            }

        };

        function sum(elems) {
            var r = 0;
            elems.each(function(){
                var p = parseFloat($(this).val());
                if (p > 0) r += p;
            });
            return r;
        }

        $('.score input').change(function() {
            refresh_totals($(this).parents('table.scoresheet'));
        });

        $('table.scoresheet').each(function() {
            refresh_totals($(this));
        });

        function update_speakers() {
            $('#resultsForm select').each(update_speaker);
        }

        function update_speaker() {
            // e.g. id_aff_speaker_1
            var parts = $(this).attr('id').split('_');
            var speaker = $(':selected', this).text();

            // e.g. '.aff.s1 label'
            var side = parts[1];
            var pos = parts[3];

            $('.' + side + '.s' + pos + ' label').html(speaker);

            var others;
            if (pos == '1') {
                others = [2, 3];
            } else if (pos == '2') {
                others = [1, 3];
            } else if (pos == '3') {
                others = [1, 2];
            } else {
                others = [];
            }

            var dupe = false;
            $.each(others, function(idx, val) {
                $sel = $('#id_'+parts[1]+'_speaker_'+val);
                if ($(':selected', $sel).text() == speaker) {
                    dupe = true;
                };
            });
            if (dupe || speaker === '---------') {
                $(this).addClass('sp_error');
            } else {
                $(this).removeClass('sp_error');
            }
        }

        $('.speaker select').change(update_speakers).each(update_speaker);

        $('#resultsForm').submit(function() {
            if ($('.sp_error', this).length) {
                alert("Fix errors!!");
                return false;
            }
        });

    });
</script>

